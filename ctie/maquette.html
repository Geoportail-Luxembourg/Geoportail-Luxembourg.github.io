<html>
<script src="//apiv3.geoportail.lu/apiv3loader.js" type="text/javascript"></script>
<link type="text/css" rel="stylesheet" href="index.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>

<body>
<div id="govbar" class="govbar govbar-light "><a href="http://gouvernement.lu" target="_blank" class="govbar-logo"><img src="//cdn.public.lu/pictures/logos/gov/gov-light.png" alt="Gouvernement du Grand-Duché de Luxembourg"></a><ul class="govbar-links"><li><a class="govbar-link" href="http://luxembourg.lu/" target="_blank">luxembourg.lu</a></li><li><a class="govbar-link" href="http://guichet.lu/" target="_blank">guichet.lu</a></li><li><a class="govbar-link" href="http://gouvernement.lu/" target="_blank">gouvernement.lu</a></li><li><a class="govbar-link govbar-more" href="http://etat.lu/" title="L’annuaire des sites internets publics luxembourgeois" target="_blank">Autres sites</a></li></ul></div>
<div class="container-fluid">
    <div class="row">
        <div id="map" class="col map"></div>
        <div class="col">
            <h1>Config panel</h1>
            <label>Search</label><span id="search"></span><br>
            <label>Url to a GeoJson file</label><input type="text" id="geojsonurl" value="https://map.geoportail.lu/mymaps/features/808e512e88f94c9fbe25ed3eae49895b"><button onclick="loadgeojson()">Import GeoJSON</button><br>
            <select id="geojsonfeature" onChange="selectGeoJsonFeature(this)"></select>
            <div id="layerManager" ></div><br>
            <div id="info"></div><br>
            <button onclick="exportgeojson()">Export Geojson selected element</button><br>
            <button onclick="exportgeojsondrawing()">Export Geojson Dessin</button><br>
            <button onclick="addInteractions('Point')">Draw a point</button><br>
            <button onclick="addInteractions('Polygon')">Draw a polygon</button><br>
            <button onclick="addInteractions('LineString')">Draw a line</button><br>
            <button onclick="removeInteractions()">Deactivate drawing tool</button><br>
            <button onclick="printPDF()">Get the image in PNG</button><br>
            <image id = "imageId" src="" width="100px"></image>
        </div>
    </div>
</div>
</body>
<script>
var geojsonlayer;
function selectGeoJsonFeature(elem) {
  geojsonlayer.then(function(layer) {
    var featureId = elem.options[elem.selectedIndex].id;
    var feature = layer.getSource().getFeatureById(featureId);
    map.getView().fit(feature.getGeometry().getExtent(), {
        size: map.getSize(),
        maxZoom: 15
    });
  });
}

function infoCb(features) {
  console.log(features[0].getProperties());
}

var map = new lux.Map({
  layers: [ '1637','359'],
  layerOpacities: [0.75, 0.8],
  layerVisibilities: [false, false],
  target: 'map',
  bgLayer: 'basemap_2015_global',
  zoom: 18,
  position: [75977, 75099],
  zoomToExtent: true,
  search      : {
    target : 'search',
    dataSets : ['Adresse', 'FLIK', 'Parcelle', 'Commune']
  },
  layerManager: {
    target: 'layerManager'
  },
   showLayerInfoPopup : true,
   popupTarget: 'info',
   layerInfoCallback: infoCb
});

function removeInteractions() {
    map.disableDrawTool();
}
function addInteractions(typeSelect) {
    removeInteractions();
    if (typeSelect === 'Point') {
        map.enableDrawPoint(function(drawendevent) {map.disableDrawTool();});
    }
    if (typeSelect === 'Polygon') {
        map.enableDrawPolygon(function(drawendevent) {map.disableDrawTool(); checkSelfIntersect(drawendevent.feature.getGeometry()); console.log(map.getGeometryLength(drawendevent.feature.getGeometry()));console.log(map.getGeometryArea(drawendevent.feature.getGeometry()));});
    }
    if (typeSelect === 'LineString') {
        map.enableDrawLine(function(drawendevent) {map.disableDrawTool();checkSelfIntersect(drawendevent.feature.getGeometry());});
    }
}

function loadgeojson() {
    var style = {
      'Point': new ol.style.Style({
        image: new ol.style.Circle({
          fill: new ol.style.Fill({
            color: 'rgba(255,255,0,0.4)'
          }),
          radius: 5,
          stroke: new ol.style.Stroke({
            color: '#ff0',
            width: 1
          })
        })
      }),
      'LineString': new ol.style.Style({
        stroke: new ol.style.Stroke({
          color: '#f00',
          width: 3
        })
      }),
      'MultiLineString': new ol.style.Style({
        stroke: new ol.style.Stroke({
          color: '#f00',
          width: 3
        })
      }),
      'Polygon': new ol.style.Style({
        stroke: new ol.style.Stroke({
          color: '#f00',
          width: 3
        })
      })
    };
    var styleFunction = function(feature) {
      return style[feature.getGeometry().getType()];
    };
   var url = document.getElementById('geojsonurl').value;
   var onFeatureAdd = function(feature) {
     var select = document.getElementById('geojsonfeature');
     var option = document.createElement("option");
     option.text = feature.get('name');
     option.id = feature.getId()
     select.add(option);
   }
   geojsonlayer = map.addGeoJSON(url, {dataProjection: 'EPSG:2169', style: styleFunction, name: 'Couche geojson', onFeatureAdd: onFeatureAdd});
}

function exportgeojson() {
    var writer = new ol.format.GeoJSON();
    var geojsonStr = writer.writeFeatures(map.getShowLayer().getSource().getFeatures());
    document.getElementById('info').innerHTML = geojsonStr;
}
function exportgeojsondrawing() {
    var writer = new ol.format.GeoJSON();
    var geojsonStr = writer.writeFeatures(map.getDrawingLayer().getSource().getFeatures());
    document.getElementById('info').innerHTML = geojsonStr;
}

function checkSelfIntersect(geom) {
 if (lux.isSelfIntersecting(geom)) {
    alert("Attenation géométrie avec une intersection");
 };
};

function printPDF() {
  document.getElementById("imageId").src = "http://apiv3.geoportail.lu/printproxy/report_create_and_get.png?spec="+encodeURIComponent(JSON.stringify(map.getPrintSpec()));
}

</script>
</html>
